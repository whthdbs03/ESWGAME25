#include "font5x7.h"

#include "render.h"
#include "st7789.h"

static const Glyph5x7 FONT[] = {
    {' ', {0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
    {'!', {0x04,0x04,0x04,0x04,0x04,0x00,0x04}},

    {'0', {0x1E,0x21,0x23,0x25,0x29,0x31,0x1E}},
    {'1', {0x04,0x0C,0x04,0x04,0x04,0x04,0x0E}},
    {'2', {0x1E,0x21,0x01,0x02,0x04,0x08,0x3F}},
    {'3', {0x1E,0x21,0x01,0x0E,0x01,0x21,0x1E}},
    {'4', {0x02,0x06,0x0A,0x12,0x3F,0x02,0x02}},
    {'5', {0x3F,0x20,0x3E,0x01,0x01,0x21,0x1E}},
    {'6', {0x0E,0x10,0x20,0x3E,0x21,0x21,0x1E}},
    {'7', {0x3F,0x01,0x02,0x04,0x08,0x08,0x08}},
    {'8', {0x1E,0x21,0x21,0x1E,0x21,0x21,0x1E}},
    {'9', {0x1E,0x21,0x21,0x1F,0x01,0x02,0x1C}},

    {'A', {0x1E,0x21,0x21,0x3F,0x21,0x21,0x21}},
    {'B', {0x3E,0x21,0x21,0x3E,0x21,0x21,0x3E}},
    {'C', {0x1E,0x21,0x20,0x20,0x20,0x21,0x1E}},
    {'D', {0x3E,0x21,0x21,0x21,0x21,0x21,0x3E}},
    {'E', {0x3F,0x20,0x20,0x3E,0x20,0x20,0x3F}},
    {'F', {0x3F,0x20,0x20,0x3E,0x20,0x20,0x20}},
    {'G', {0x1E,0x21,0x20,0x27,0x21,0x21,0x1E}},
    {'H', {0x21,0x21,0x21,0x3F,0x21,0x21,0x21}},
    {'I', {0x1F,0x04,0x04,0x04,0x04,0x04,0x1F}},
    {'J', {0x0F,0x02,0x02,0x02,0x02,0x22,0x1C}},
    {'K', {0x21,0x22,0x24,0x38,0x24,0x22,0x21}},
    {'L', {0x20,0x20,0x20,0x20,0x20,0x20,0x3F}},
    {'M', {0x21,0x33,0x2D,0x21,0x21,0x21,0x21}},
    {'N', {0x21,0x31,0x29,0x25,0x23,0x21,0x21}},
    {'O', {0x1E,0x21,0x21,0x21,0x21,0x21,0x1E}},
    {'P', {0x3E,0x21,0x21,0x3E,0x20,0x20,0x20}},
    {'Q', {0x1E,0x21,0x21,0x21,0x25,0x22,0x1D}},
    {'R', {0x3E,0x21,0x21,0x3E,0x24,0x22,0x21}},
    {'S', {0x1F,0x20,0x20,0x1E,0x01,0x01,0x3E}},
    {'T', {0x3F,0x04,0x04,0x04,0x04,0x04,0x04}},
    {'U', {0x21,0x21,0x21,0x21,0x21,0x21,0x1E}},
    {'V', {0x21,0x21,0x21,0x21,0x21,0x12,0x0C}},
    {'W', {0x21,0x21,0x21,0x21,0x2D,0x33,0x21}},
    {'X', {0x21,0x21,0x12,0x0C,0x12,0x21,0x21}},
    {'Y', {0x21,0x21,0x12,0x0C,0x04,0x04,0x04}},
    {'Z', {0x3F,0x01,0x02,0x04,0x08,0x10,0x3F}},
};

static const Glyph5x7* get_glyph(char c) { // 글리프 검색
    if (c >= 'a' && c <= 'z') c = (char)(c - 'a' + 'A'); // 소문자를 대문자로 변환
    for (unsigned i = 0; i < sizeof(FONT) / sizeof(FONT[0]); i++) { // 글리프 배열 검색
        if (FONT[i].ch == c) return &FONT[i]; // 일치하는 글리프 반환
    }
    return &FONT[0]; // 없으면 공백 글리프 반환
}

int str_len(const char* s) { // 문자열 길이 반환
    int n = 0;
    while (s[n]) n++;
    return n;
}

void draw_char_5x7_px(int px, int py, char c, int s, uint16_t color) { // 문자 그리기
    const Glyph5x7* g = get_glyph(c); // 글리프 가져오기
    for (int row = 0; row < 7; row++) { // 7행 반복
        uint8_t bits = g->rows[row]; // 해당 행의 비트 패턴
        for (int col = 0; col < 5; col++) { // 5열 반복
            if (bits & (1 << (4 - col))) { // 해당 비트가   1이면
                dot(px + col * s, py + row * s, s, color); // 점 그리기
            }
        }
    }
}

void draw_text_center_px(const char* s, int py, int sdot, uint16_t color) { // 중앙 정렬 텍스트 그리기
    int len = str_len(s);
    int char_w = 5 * sdot;
    int gap = 1 * sdot;
    int text_w = len * char_w + (len - 1) * gap;

    int px = (ST7789_TFTWIDTH - text_w) / 2;
    for (int i = 0; i < len; i++) {
        draw_char_5x7_px(px + i * (char_w + gap), py, s[i], sdot, color);
    }
}
